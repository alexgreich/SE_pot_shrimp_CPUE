---
title: "District 7"
author: "Alex Reich"
date: "2024-04-24"
output: html_document
---
I do not  remember if I need to use the following code:
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Anyway, let's get started. This document will look at management unit District 7 for pot (spot) shrimp standardization. It will load in the (pre-wrangled) data, wrangle further for district 1, and then some EDA (focusing on variables of interest and correlation). The analysis will be by district with an HGAM (hierarchical GAM) with the variables of interest as fixed effects and Analysis Area as a random effect. I will do model selection on a few versions of this HGAM. I will then make graphs of the standardized CPUE (by district and) and whatever else Max wants. THEN, I will run individual models by analysis areas, ideally with an automated function, and compare the graphs of those automated functions to the cpue of the ranef model.This will help me decide if models should be by MANAGEMENT UNIT (larger) or by ANALYSIS AREA (smaller). In hindsight, I should start with District 7, since I have explored the Upper Ernest sound data extensively.Ok, now the RMD is named accordingly 


Load libraries
```{r}
library(tidyverse)
library(ggplot2)
library(cowplot)
library(viridis)
library(RColorBrewer)
library(mgcv)
```


Load the data and select for D7
```{r}
wrangled_shrimp <- read.csv("Data/wrangled shrimp focus years.csv")
D7 <- wrangled_shrimp %>% filter(Management_unit == "District 7") %>%
  mutate(Analysis.Area = factor(Analysis.Area),
         ADFG.Number = factor(ADFG.Number),
         Season.Ref = factor(Season.Ref)
         )#make things factors for the gams

unique(D7$Analysis.Area)
```


District 7 contains analysis areas:
  Bradfield Canal
  Lower Ernest Sound
  Upper Ernest Sound
  Zimovia Strait
  
  
  
## Exploratory Data Analysis for D7
Variables of interest:
Random effect: Analysis.Area
Fixed effects: jdate (smoothed and... cyclical?), vessel # (the count of vessels), ADFG # (individual vessel (fixed or random effect??)), Season aka year, 
--If I do not include jdate, simplifies things?
Response: nominal cpue

Q: should I do something besides a log-transformation?
```{r}

#cpue dist
ggplot(D7) + aes(x=CPUE_nom) + geom_density()
ggplot(D7) + aes(x=log(CPUE_nom+0.001)) + geom_density()
qqnorm(log(D7$CPUE_nom)) #that kind of looks bad. Maybe somehting other than log-trans?
qqnorm(D7$CPUE_nom)

ggplot(D7) + aes(x=CPUE_nom) + geom_density()+facet_wrap(~Analysis.Area)
ggplot(D7) + aes(x=log(CPUE_nom+0.001)) + geom_density()+facet_wrap(~Analysis.Area)

#cpue by year
ggplot(D7) + aes(x=factor(Season.Ref), y=CPUE_nom) + geom_point() #ther is a big outlier
ggplot(D7) + aes(x=factor(Season.Ref), y=CPUE_nom) + geom_boxplot(outliers = F)

ggplot(D7) + aes(x=factor(Season.Ref), y=CPUE_nom) + geom_boxplot(outliers = F) + facet_wrap(~Analysis.Area) #cpue varies... cyclically with time. Is season a fixed effect? I want to estimate it, so probs not. its def not linear.

#catch by year
ggplot(D7) + aes(x=factor(Season.Ref), y=total_weight) + geom_boxplot() #this is total weight per fish ticket.
ggplot(D7) + aes(x=factor(Season.Ref), y=max_pots_2) + geom_boxplot()
ggplot(D7) + aes(x=factor(Season.Ref), y=max_pots_2) + geom_boxplot(outliers=F)

ggplot(D7) + aes(x=factor(Season.Ref), y=total_weight) + geom_boxplot() + facet_wrap(~Analysis.Area) #max pots per fish ticket
ggplot(D7) + aes(x=factor(Season.Ref), y=max_pots_2) + geom_boxplot(outliers=F) + facet_wrap(~Analysis.Area)


#cpue and vessel count
ggplot(D7) + aes(x=factor(vessel_count_mgmt_u), y=log(CPUE_nom)) + geom_boxplot()
ggplot(D7) + aes(x=factor(vessel_count_mgmt_u), y=log(CPUE_nom)) + geom_boxplot(outliers=F)
ggplot(D7) + aes(x=factor(vessel_count_mgmt_u), y=log(CPUE_nom)) + geom_boxplot(outliers=F) + facet_wrap(~Analysis.Area)

#cpue and district


#cpue and jdate



#correlation plot
library(corrplot)
D7_interest_cor <- D7 %>% select(CPUE_nom, jdate, vessel_count_mgmt_u)
cor_prep <- cor(D7_interest_cor)
corrplot(cor_prep)
?pairs


#check model residuals, see if we need ar1 correlation in the model
```


Analysis and model testing: district 7 GAM with random effects
GAMM with ar1 autocorrelation (is this too complciated?)
```{r}
#null model
m0 <- gam(log(CPUE_nom + 0.001) ~ factor(Season.Ref) ,data= D7 ) #how to add temporal autocorrealtion to this tho?

#intermediate models


#global model
m_glob_r <- gam(log(CPUE_nom + 0.001) ~ Season.Ref + ADFG.Number+ s(vessel_count_mgmt_u, k=4) + s(jdate, k=4) + s(Analysis.Area, bs="re", k=4), data=D7 ) #remove jdate? #crap should ADFG.Number be a\random effect too?
##do I need to make this a factor somewhere else?


##how to alter the random effect to have a random global slope? See that paper.
#maybe try the GI, GS, G, I, S method like in the Pederson paper.
  
  
#first decide if ranef or not, via global model?


#https://stackoverflow.com/questions/47586110/autocorrelation-in-generalized-additive-models-gam  #how to add ar1 to my gam
##is this necessary or too complicated?
##gamm() with correllation = corAR1(form = ~time) where time is the var giving me ordering in time of the evently spaced observations
##or bam() and specify rho, the ar1 parameter
###check model residuals tho to see if we NEED ar1
```
Some wild experimentation below,
delete later and keep what is useful
```{r}
#null model
m0 <- gam(log(CPUE_nom + 0.001) ~ factor(Season.Ref) ,data= D7, method="ML" ) #how to add temporal autocorrealtion to this tho?

m_glob_r <- gam(log(CPUE_nom + 0.001) ~ Season.Ref + s(ADFG.Number, bs="re")+ s(vessel_count_mgmt_u, k=4) + s(jdate, k=4) + s(Analysis.Area, bs="re", k=4), data=D7 , method="ML") 

m_glob_r_2 <- gam(log(CPUE_nom + 0.001) ~ Season.Ref+ ADFG.Number + s(vessel_count_mgmt_u, k=4) + s(jdate, k=4) + s(Analysis.Area, bs="re", k=4), data=D7, method="ML" )

m_glob_nr <- gam(log(CPUE_nom + 0.001) ~ Season.Ref + ADFG.Number+ s(vessel_count_mgmt_u, k=4) + s(jdate, k=4), data=D7, method="ML") 

#do I need random effects in the model, and which random effects?
AIC(m_glob_r, m_glob_r_2, m_glob_nr, m0) #m glob r wins, but not by much


#get rid some variables
summary(m_glob_r)
m_3 <- gam(log(CPUE_nom + 0.001) ~ Season.Ref + s(ADFG.Number, bs="re")+ s(jdate, k=4) + s(Analysis.Area, bs="re", k=4), data=D7, method="ML" ) 

AIC(m_glob_r, m_3) #same, meaning drop vessel count
summary(m_3)

#oh shit tho, let me check temporal autocorrelation, maybe I should check for interactions
?acf
acf(residuals(m_glob_r),main="raw residual ACF") #yeah, some autocorrelation

#so...what do I do?

#try the global model with interaction effects, see if autocorrelation still exists
#https://r.qcbs.ca/workshop08/book-en/gam-with-interaction-terms.html
#m_glob_r_int <- gam(log(CPUE_nom + 0.001) ~ Season.Ref + s(ADFG.Number, bs="re")+ s(vessel_count_mgmt_u, k=4) + s(jdate, k=4) + s(Analysis.Area, bs="re", k=4), data=D7 , method="ML") +
 #s() #interaction effects

#ok ummm, maybe do smaller levels first to chekc for int
mod_int_1 <- gam(log(CPUE_nom + 0.001) ~ Season.Ref + s(ADFG.Number, bs="re")+ s(vessel_count_mgmt_u, k=4) + s(vessel_count_mgmt_u, by=Season.Ref, k=4) + s(Analysis.Area, bs="re", k=4), data=D7 , method="REML") #

summary(mod_int_1)
summary(m_glob_r)


```

Let's try things the pederson way (Delete later except for stuff that is good)
```{r}

```

But wait do I even, like, need a GAM?
m_glob_r <- gam(log(CPUE_nom + 0.001) ~ Season.Ref + s(ADFG.Number, bs="re")+ s(vessel_count_mgmt_u, k=4) + s(jdate, k=4) + s(Analysis.Area, bs="re", k=4), data=D7 , method="ML") 
```{r}


#log cpue vs. ADFG number (ok thats a radom effect)
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=ADFG.Number) + geom_boxplot()
###oh maybe this should be a special random effect. I forget
##this: Random factor smooth interactions
#bs="fs" A special smoother class (see smooth.construct.fs.smooth.spec) is available for the case in which a smooth is required at each of a large number of factor levels (for example a smooth for each patient in a study), and each smooth should have the same smoothing parameter. The "fs" smoothers are set up to be efficient when used with gamm, and have penalties on each null sapce component (i.e. they are fully ‘random effects’). from: https://stat.ethz.ch/R-manual/R-patched/RHOME/library/mgcv/html/smooth.terms.html
#or just a regular random effect. can try both ways. why not

#log cpue vs. season ref (is this smoothed in phil's code??)
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=Season.Ref) + geom_boxplot(outliers=F) #totally autocorrelated

#log cpue vs. Analysis area (also a random effect)
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=Analysis.Area) + geom_boxplot() #ok they're not... that different
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=Analysis.Area) + geom_boxplot(outliers=F)
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=Analysis.Area) + geom_violin()

ggplot(D7) + aes(y= CPUE_nom, x=Analysis.Area) + geom_boxplot(outliers=F)
ggplot(D7) + aes(y= CPUE_nom, x=Analysis.Area) + geom_violin()

#log cpue vs jdate (is this worth including, because the season might not be so important to look at, migjt give uneven results since fishing season recently shifted)
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=jdate) + geom_smooth() #i think maybe jdate isnt necessary because the fishing season is a specific window.

#log cpue vs. vessel count
##vessel count by year and analysis area
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=vessel_count_aa) + geom_smooth()
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=vessel_count_aa) + geom_smooth() + geom_point() #ok that puts thigs in perspective
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=vessel_count_aa) + geom_smooth(method = "lm")# + geom_point()
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=vessel_count_aa) + geom_smooth(method = "lm") + geom_point()
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=vessel_count_aa) + geom_point()

ggplot(D7) + aes(y= CPUE_nom, x=vessel_count_aa) + geom_smooth()
ggplot(D7) + aes(y= CPUE_nom, x=vessel_count_aa) + geom_smooth(method = "lm") #ok teh change in cpue is super small. Like, 1 pound. Idbutk if that matters 
ggplot(D7) + aes(y= CPUE_nom, x=vessel_count_aa) + geom_smooth(method = "lm") + geom_point()

##vessel count by year and mgmt u
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=vessel_count_mgmt_u) + geom_smooth()
ggplot(D7) + aes(y= log(CPUE_nom+0.001), x=vessel_count_mgmt_u) + geom_point()
```

The analysis above gives me:
Analysis area probs matters as a ranef
ADFG ID matters as a ranef (or fixef, what did Phil and Tyler do?)
Can include number of vessels but I think it will get cut out. Unsure if smooth or linear, try both.

I do not think I should use jdate.


Alright round 2 mod selection after thinking about it a bit, following logic above.
log(CPUE+0.001) ~ Season.Ref + s(vessel_count_aa, k=4 or 3) + s(Analysis.Area, bs="re") + s(ADFG ID, bs="re") and int effects?
   int effects between Season ref and analysis area
   int effects between season ref and ADFG ID
```{r}
mod_g_new <- gam(log(CPUE_nom+0.001) ~ Season.Ref + s(vessel_count_aa, k=4) + s(Analysis.Area, bs="re") + s(ADFG.Number, bs="re"), method = "ML", data=D7)

summary(mod_g_new)

#(do I test temporal int effects before adding temporal autocorrelation??)
#is there temporal autocorrelation

acf(residuals(mod_g_new),main="raw residual ACF") #yep. AR1?

#add correlation structure
mod_g_new_gamm <- gamm(log(CPUE_nom+0.001) ~ Season.Ref + s(vessel_count_aa, k=4) + s(Analysis.Area, bs="re") + s(ADFG.Number, bs="re"), method = "REML", data=D7) #no autocorr
summary(mod_g_new_gamm$gam)

gamm_corr <- gamm(log(CPUE_nom+0.001) ~ Season.Ref + s(vessel_count_aa, k=4) + s(Analysis.Area, bs="re") + s(ADFG.Number, bs="re"), method = "REML", data=D7, correlation = corAR1(0.4,form = ~1|Season.Ref)) #yes autocorr #form = ~ Season.Ref had to delete from inside the corAR1 argument
#I do not know if this is right
?corAR1

gamm_corr_2 <- gamm(log(CPUE_nom+0.001) ~ Season.Ref + s(vessel_count_aa, k=4) + s(Analysis.Area, bs="re") + s(ADFG.Number, bs="re"), method = "REML", data=D7, correlation = corAR1(0.4))

summary(gamm_corr$gam)
acf(residuals(gamm_corr$gam),main="raw residual ACF") #well that did not work
acf(residuals(gamm_corr_2$gam),main="raw residual ACF")

AIC(gamm_corr, mod_g_new_gamm) #mgith have to go $gam
```




Analysis and model testing: individual analysis areas
```{r}
#Bradfield canal

#Lower ernest sound

#upper ernest sound

#Zimovia strait


```

Comparison graphs
```{r}

```

Results graphs
```{r}

```

